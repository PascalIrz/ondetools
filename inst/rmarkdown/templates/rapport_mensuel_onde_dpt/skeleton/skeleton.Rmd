---
title: "Bilan mensuel ONDE  \nObservatoire national des étiages  \nDépartement `r params$code_departement`"
author: "OFB, DR `r params$region_dr`"
date: "Campagne `r params$type_rapport` de `r params$mois_rapport`  \nrapport créé le `r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
    reference_docx: "modele_word_rapport_OFB.docx"
params:
  onde_df: NULL
  code_departement: NULL
  annee_rapport: NULL
  mois_rapport: NULL
  region_dr: NULL
  type_rapport: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning=FALSE, 
                      message=FALSE)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
options(warn=-1)

if(!require("tidyverse")) install.packages('tidyverse')
if(!require("COGiter")) devtools::install_github("MaelTheuliere/COGiter")
```

\newpage

# Rappels réseau ONDE : informations générales pour le déroulement des campagnes d'acquisition de données

Les stations d'observations du réseau ONDE sont majoritairement positionnées en tête de bassin pour apporter de l'information sur les situations hydrographiques non couvertes par d'autres dispositifs existants (banque [HYDRO](http://www.hydro.eaufrance.fr/) et [ADES](http://www.ades.eaufrance.fr/) par exemple). Environ 30 stations compose le réseau de chaque département. 

Le réseau ONDE s'organise selon deux types de suivis : **(i) un suivi usuel** (au milieu de chaque dernière décade du mois, le 25 ± 2 jours, entre fin mai et fin septembre), et **(ii) un suivi complémentaire** (déclenché selon la situation locale, jugée potentiellement sensible, à l'initiative des acteurs locaux).

Sur le terrain, la situation d'écoulement des cours d'eau est appréciée visuellement selon **plusieurs modalités** d'observation avec la **typologie nationale** :

-   **<span custom-style="Ecoulement_style">Ecoulement visible</span>**: correspond à une station présentant un écoulement continu -- écoulement permanent et visible à l'œil nu.
-   **<span custom-style="Ecoulement_nonvisible_style">Ecoulement non visible</span>
**: correspond à une station sur laquelle le lit mineur présente toujours de l'eau mais le débit est nul.
-   **<span custom-style="Assec_style">Assec</span>**: correspond à une station à sec, où l'eau est totalement évaporée ou infiltrée sur plus de 50% de la station.

Un autre modalité - **<span custom-style="Ecoul_visible_faible">Ecoulement visible faible</span>** - est parfois utilisée sur le terrain (distinction avec la modalité **<span custom-style="Ecoulement_style">Ecoulement visible acceptable</span>**). Elle apparaît dans la **typologie départementale** ; et correspond à une station sur laquelle il y a de l'eau et un courant visible, mais le débit faible ne garantit pas un fonctionnement biologique.

A noter que la modalité **observation impossible** peut également être renseignée, dès lors que l'observation n'a pu être réalisée correctement en raison de conditions exceptionnelles (problèmes d'accessibilité, modification des conditions environnementales de la station, etc ...).

Pour plus d'informations : [Lien réseau ONDE (http://onde.eaufrance.fr)](https://onde.eaufrance.fr/).

# Nombre de stations ONDE dans le département `r params$code_departement`

```{r, include=FALSE, echo=FALSE}
### prétraitement sur le département
nb_stations <- params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement & libelle_type_campagne == 'usuelle') %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(code_station) %>% 
  unique() %>% 
  length()

date_derniere_campagne_usuelle <- params$onde_df %>% 
  dplyr::filter(libelle_type_campagne == 'usuelle') %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(date_campagne) %>% 
  unique()

date_derniere_campagne_usuelle <- format(date_derniere_campagne_usuelle, '%d/%m/%Y')
  
date_derniere_campagne_compl <- params$onde_df %>% 
  dplyr::filter(libelle_type_campagne == 'complémentaire') %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(date_campagne) %>% 
  unique()

date_derniere_campagne_compl <- format(date_derniere_campagne_compl, '%d/%m/%Y')

### tableau pour le mois en cours selectionné
mois_sel <- format(lubridate::ym(annee_mois), "%m")
annee_sel <- format(lubridate::ym(annee_mois), "%Y")

onde_df_mois <-
  params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(Mois = format(as.Date(date_campagne), "%m")) %>% 
  dplyr::filter(libelle_type_campagne == params$type_rapport) %>% 
  dplyr::filter(Mois == mois_sel & Annee == annee_sel) %>% 
  dplyr::filter(code_campagne == max(as.numeric(code_campagne)))

### dpt shape
dptFR <-
  COGiter::departements_geo %>%
  dplyr::left_join(COGiter::departements %>%
                     dplyr::select(DEP, REG, NOM_DEP))


### tableau pour les bilans du type d'écoulement
onde_bilan_ecoulement_annee_nat <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::filter(code_campagne <= unique(onde_df_mois$code_campagne)) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible",
                                           #"Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie nationale",
                            force_complementaire = T)

onde_bilan_ecoulement_annee_dpt <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::filter(code_campagne <= unique(onde_df_mois$code_campagne)) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible acceptable",
                                           "Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie départementale",
                            force_complementaire = T)
```

Actuellement, le **département `r params$code_departement`** est couvert par **`r nb_stations` stations** d'observations. 

Pour le département, les dernières campagnes :

- **usuelles** ont été réalisées le : *`r date_derniere_campagne_usuelle`* ;

- **complémentaires** ont été réalisées le : *`r date_derniere_campagne_compl`*.

# Situation à l'échelle départementale pour le mois en cours

Les cartes ci-dessous présentent les situations observées sur les stations du **département `r params$code_departement`** pour la campagne **`r params$type_rapport` du mois de `r params$mois_rapport`**. 

### Typologie nationale

Les modalités d'écoulement de la **typologie nationale** peuvent prendre les valeurs suivantes: *<span custom-style="Ecoulement_style">écoulement visible</span>*, *<span custom-style="Ecoulement_nonvisible_style">écoulement non visible</span>*, *<span custom-style="Assec_style">assec</span>*, ou *observation impossible*.

```{r map dpt nat, results='asis', echo=FALSE, crop=T, fig.width=5.5, fig.height=5.5, dpi=300}
produire_carte_statique(code_departement = params$code_departement,
                        onde_df_mois = onde_df_mois,
                        referentiel_onde = 'Typologie nationale',
                        couleurs = onde_4mod,
                        dptFR_shp = dptFR)

```

```{r bilan ecoulement annee nat, results='asis', echo=FALSE, fig.width=6, fig.height=3.5, dpi=300}
produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_annee_nat,
                               lib_ecoulement = lib_ecoul,
                               historique = F) +
  ggplot2::labs(title= glue::glue("Types d'écoulement de l'année - département {params$code_departement}")) + ggplot2::theme(legend.position = 'none')

```

### Typologie départementale

Les modalités d'écoulement de la **typologie départementale** correspondent à : *<span custom-style="Ecoulement_style">écoulement visible acceptable</span>*, *<span custom-style="Ecoul_visible_faible">écoulement visible faible</span>*, *<span custom-style="Ecoulement_nonvisible_style">écoulement non visible</span>*, *<span custom-style="Assec_style">assec</span>*, ou *observation impossible*.

```{r map dpt dpt, results='asis', echo=FALSE, crop=T, fig.width=5.5, fig.height=5, dpi=300}
produire_carte_statique(code_departement = params$code_departement,
                        onde_df_mois = onde_df_mois,
                        referentiel_onde = 'Typologie départementale',
                        couleurs = onde_5mod,
                        dptFR_shp = dptFR)

```

```{r bilan ecoulement annee dpt, results='asis', echo=FALSE, fig.width=5.5, fig.height=3.5, dpi=300}
produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_annee_dpt,
                               lib_ecoulement = lib_ecoul,
                               historique = F) +
  ggplot2::labs(title= glue::glue("Types d'écoulement de l'année - département {params$code_departement}")) +
  ggplot2::theme(legend.position = 'none')
```

\newpage

# Analyse pluriannuelle à l'échelle départementale
## Indices ONDE

Pour chaque campagne usuelle, un indice ONDE peut être calculé selon la formule suivante :

$$
\text{Indice ONDE} = \frac{( 5 \times N2 + 10 \times N1)}{N}
$$
avec :

  - *N* : nombre total de stations ;
  - *N1* : écoulement continu ;
  - *N2* : écoulement interrompu.

⚠ *Les indices ONDE des campagnes complémentaires calculés ci-dessous sont présentés à titre indicatif. Seules les campagnes usuelles permettent le calcul de cet indice. Ici, ils ont été calculés pour les complémentaires dès lors qu'un nombre suffisant de stations le permettait.*

#### Historique de variation de l'indice ONDE (par mois et campagnes)

```{r indice onde, echo=FALSE}
indice_onde_tab <- 
  params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  ondetools::calculer_indice_onde(onde_df = ., force_complementaire = T)

indice_onde_tab %>% 
  ungroup() %>% 
  dplyr::select(date_campagne, Annee, indice, libelle_type_campagne) %>% 
  dplyr::arrange(date_campagne) %>% 
  dplyr::mutate(Mois = format(date_campagne, "%m"),
         Mois_c = paste(Mois, substr(libelle_type_campagne,1,4),sep = "_")) %>% 
  dplyr::select(-date_campagne, -libelle_type_campagne, -Mois) %>% 
  dplyr::mutate(Annee = as.character(Annee)) %>% 
  dplyr::filter(!is.na(indice)) %>% 
  dplyr::rename("Années" = 'Annee') %>% 
  tidyr::pivot_wider(names_from = Mois_c, values_from = indice, names_sort = T, values_fn = toString) %>% 
  flextable::flextable() |> 
  flextable::separate_header() |> 
  #flextable::autofit() %>% 
  flextable::align(align = "center", part = "all") %>% 
  #flextable::colformat_double(digits = 1) %>% 
  flextable::bold(part = 'header', i = 1) %>% 
  flextable::bold(part = "body", j = 1) %>%
  flextable::italic(part = 'header', i = 2) %>% 
  flextable::fontsize(size=9, part = c("all")) %>% 
  flextable::width(width = 0.6) %>% 
  flextable::border_inner_v(part="all", border = flextable::fp_border_default(color="gray", width = 1) )
```

\newpage

## Historique des types d'écoulement

Les pourcentages de chaque type d'écoulement selon la typologie départementale sont présentés ci-dessous par années, mois et campagnes (usuelles *usue* et complémentaires *comp*).

```{r bilan ecoulement historique, results='asis', echo=FALSE, fig.width=11, fig.height=7, dpi=600}
onde_bilan_ecoulement_historique <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible acceptable",
                                           "Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie départementale",
                            force_complementaire = T)

produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_historique,
                               lib_ecoulement = lib_ecoul,
                               historique = T)
```


\newpage

## Historique des assecs

\newpage

## Historique des observations par stations regroupées par bassins versants

\newpage

## Commentaires spécifiques

:::{custom-style="Style1"}

Ajouter les éventuels commentaires ici

:::
