---
title: "Bilan mensuel ONDE  \nObservatoire national des étiages  \nDépartement `r params$code_departement`"
author: "OFB, DR `r params$region_dr`"
date: "Campagne `r params$type_rapport` de `r params$mois_rapport`  \nrapport créé le `r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
    reference_docx: "modele_word_rapport_OFB.docx"
params:
  onde_df: NULL
  code_departement: NULL
  annee_rapport: NULL
  mois_rapport: NULL
  region_dr: NULL
  type_rapport: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning=FALSE, 
                      message=FALSE)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
options(warn=-1)

if(!require("tidyverse")) install.packages('tidyverse')
if(!require("patchwork")) install.packages('patchwork')
if(!require("flextable")) install.packages('flextable')
if(!require("magick")) install.packages('magick')
if(!require("COGiter")) devtools::install_github("MaelTheuliere/COGiter")
```

\newpage

# Rappels réseau ONDE : informations générales pour le déroulement des campagnes d'acquisition de données

Les stations d'observations du réseau ONDE sont majoritairement positionnées en tête de bassin pour apporter de l'information sur les situations hydrographiques non couvertes par d'autres dispositifs existants (banque [HYDRO](http://www.hydro.eaufrance.fr/) et [ADES](http://www.ades.eaufrance.fr/) par exemple). Environ 30 stations compose le réseau de chaque département. 

Le réseau ONDE s'organise selon deux types de suivis : **(i) un suivi usuel** (au milieu de chaque dernière décade du mois, le 25 ± 2 jours, entre fin mai et fin septembre), et **(ii) un suivi complémentaire** (déclenché selon la situation locale, jugée potentiellement sensible, à l'initiative des acteurs locaux).

Sur le terrain, la situation d'écoulement des cours d'eau est appréciée visuellement selon **plusieurs modalités** d'observation avec la **typologie nationale** :

-   **<span custom-style="Ecoulement_style">Ecoulement visible</span>**: correspond à une station présentant un écoulement continu -- écoulement permanent et visible à l'œil nu.
-   **<span custom-style="Ecoulement_nonvisible_style">Ecoulement non visible</span>
**: correspond à une station sur laquelle le lit mineur présente toujours de l'eau mais le débit est nul.
-   **<span custom-style="Assec_style">Assec</span>**: correspond à une station à sec, où l'eau est totalement évaporée ou infiltrée sur plus de 50% de la station.

Une autre modalité - **<span custom-style="Ecoul_visible_faible">Ecoulement visible faible</span>** - est parfois utilisée sur le terrain (distinction avec la modalité **<span custom-style="Ecoulement_style">Ecoulement visible acceptable</span>**). Elle apparaît dans la **typologie départementale** ; et correspond à une station sur laquelle il y a de l'eau et un courant visible, mais le débit faible ne garantit pas un fonctionnement biologique.

A noter que la modalité **observation impossible** peut également être renseignée, dès lors que l'observation n'a pu être réalisée correctement en raison de conditions exceptionnelles (problèmes d'accessibilité, modification des conditions environnementales de la station, etc ...).

Pour plus d'informations : [Lien réseau ONDE (http://onde.eaufrance.fr)](https://onde.eaufrance.fr/).

# Nombre de stations ONDE dans le département `r params$code_departement`

```{r, include=FALSE, echo=FALSE}
### prétraitement sur le département
nb_stations <- params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement & libelle_type_campagne == 'usuelle') %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(code_station) %>% 
  unique() %>% 
  length()

date_derniere_campagne_usuelle <- params$onde_df %>% 
  dplyr::filter(libelle_type_campagne == 'usuelle') %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(date_campagne) %>% 
  unique()

date_derniere_campagne_usuelle <- format(date_derniere_campagne_usuelle, '%d/%m/%Y')
  
date_derniere_campagne_compl <- params$onde_df %>% 
  dplyr::filter(libelle_type_campagne == 'complémentaire') %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(code_campagne = as.numeric(code_campagne)) %>% 
  dplyr::filter(code_campagne == max(code_campagne)) %>% 
  dplyr::pull(date_campagne) %>% 
  unique()

date_derniere_campagne_compl <- format(date_derniere_campagne_compl, '%d/%m/%Y')

### tableau pour le mois en cours selectionné
mois_sel <- format(lubridate::ym(annee_mois), "%m")
annee_sel <- format(lubridate::ym(annee_mois), "%Y")

onde_df_mois <-
  params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::mutate(Mois = format(as.Date(date_campagne), "%m")) %>% 
  dplyr::filter(libelle_type_campagne == params$type_rapport) %>% 
  dplyr::filter(Mois == mois_sel & Annee == annee_sel) %>% 
  dplyr::filter(code_campagne == max(as.numeric(code_campagne)))

### dpt shape
dptFR <-
  COGiter::departements_geo %>%
  dplyr::left_join(COGiter::departements %>%
                     dplyr::select(DEP, REG, NOM_DEP)) %>% 
  sf::st_transform(crs = 2154)


### tableau pour les bilans du type d'écoulement
onde_bilan_ecoulement_annee_nat <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::filter(code_campagne <= unique(onde_df_mois$code_campagne)) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible",
                                           #"Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie nationale",
                            force_complementaire = T)

onde_bilan_ecoulement_annee_dpt <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::filter(code_campagne <= unique(onde_df_mois$code_campagne)) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible acceptable",
                                           "Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie départementale",
                            force_complementaire = T)
```

Actuellement, le **département `r params$code_departement`** est couvert par **`r nb_stations` stations** d'observations. 

Pour le département, les dernières campagnes :

- **usuelles** ont été réalisées le : *`r date_derniere_campagne_usuelle`* ;

- **complémentaires** ont été réalisées le : *`r date_derniere_campagne_compl`*.

# Situation à l'échelle départementale pour le mois en cours

Les cartes ci-dessous présentent les situations observées sur les stations du **département `r params$code_departement`** pour la campagne **`r params$type_rapport` du mois de `r params$mois_rapport`**. 

### Typologie nationale

Les modalités d'écoulement de la **typologie nationale** peuvent prendre les valeurs suivantes: *<span custom-style="Ecoulement_style">écoulement visible</span>*, *<span custom-style="Ecoulement_nonvisible_style">écoulement non visible</span>*, *<span custom-style="Assec_style">assec</span>*, ou *observation impossible*.

```{r map dpt nat, results='asis', echo=FALSE, crop=T, fig.width=5, fig.height=5, dpi=300}
produire_carte_statique(code_departement = params$code_departement,
                        onde_df_mois = onde_df_mois,
                        referentiel_onde = 'Typologie nationale',
                        couleurs = onde_4mod,
                        dptFR_shp = dptFR)

```

```{r bilan ecoulement annee nat, results='asis', echo=FALSE, fig.width=5.5, fig.height=3.2, dpi=300}
produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_annee_nat,
                               lib_ecoulement = lib_ecoul,
                               historique = F) +
  ggplot2::labs(title= glue::glue("Types d'écoulement de l'année - département {params$code_departement}")) + ggplot2::theme(legend.position = 'none')

```

\newpage

### Typologie départementale

Les modalités d'écoulement de la **typologie départementale** correspondent à : *<span custom-style="Ecoulement_style">écoulement visible acceptable</span>*, *<span custom-style="Ecoul_visible_faible">écoulement visible faible</span>*, *<span custom-style="Ecoulement_nonvisible_style">écoulement non visible</span>*, *<span custom-style="Assec_style">assec</span>*, ou *observation impossible*.

```{r map dpt dpt, results='asis', echo=FALSE, crop=T, fig.width=5, fig.height=5, dpi=300}
produire_carte_statique(code_departement = params$code_departement,
                        onde_df_mois = onde_df_mois,
                        referentiel_onde = 'Typologie départementale',
                        couleurs = onde_5mod,
                        dptFR_shp = dptFR)

```

```{r bilan ecoulement annee dpt, results='asis', echo=FALSE, fig.width=5.5, fig.height=3.2, dpi=300}
produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_annee_dpt,
                               lib_ecoulement = lib_ecoul,
                               historique = F) +
  ggplot2::labs(title= glue::glue("Types d'écoulement de l'année - département {params$code_departement}")) +
  ggplot2::theme(legend.position = 'none')
```

\newpage

# Analyse pluriannuelle à l'échelle départementale
## Indices ONDE

Pour chaque campagne usuelle, un indice ONDE peut être calculé selon la formule suivante :

$$
\text{Indice ONDE} = \frac{( 5 \times N2 + 10 \times N1)}{N}
$$
avec :

  - *N* : nombre total de stations ;
  - *N1* : écoulement continu ;
  - *N2* : écoulement interrompu.

⚠ *Les indices ONDE des campagnes complémentaires calculés ci-dessous sont présentés à titre indicatif. Seules les campagnes usuelles permettent le calcul de cet indice. Ici, ils ont été calculés pour les complémentaires dès lors qu'un nombre suffisant de stations le permettait.*

#### Historique de variation de l'indice ONDE (par mois et campagnes)

```{r indice onde, echo=FALSE}
indice_onde_tab <- 
  params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  ondetools::calculer_indice_onde(onde_df = ., force_complementaire = T)

indice_onde_tab %>% 
  ungroup() %>% 
  dplyr::select(date_campagne, Annee, indice, libelle_type_campagne) %>% 
  dplyr::arrange(date_campagne) %>% 
  dplyr::mutate(Mois = format(date_campagne, "%m"),
         Mois_c = paste(Mois, substr(libelle_type_campagne,1,4),sep = "_")) %>% 
  dplyr::select(-date_campagne, -libelle_type_campagne, -Mois) %>% 
  dplyr::mutate(Annee = as.character(Annee)) %>% 
  dplyr::filter(!is.na(indice)) %>% 
  dplyr::rename("Années" = 'Annee') %>% 
  tidyr::pivot_wider(names_from = Mois_c, values_from = indice, names_sort = T, values_fn = toString) %>% 
  flextable::flextable() |> 
  flextable::separate_header() |> 
  #flextable::autofit() %>% 
  flextable::align(align = "center", part = "all") %>% 
  #flextable::colformat_double(digits = 1) %>% 
  flextable::bold(part = 'header', i = 1) %>% 
  flextable::bold(part = "body", j = 1) %>%
  flextable::italic(part = 'header', i = 2) %>% 
  flextable::fontsize(size=8.5, part = c("all")) %>% 
  flextable::width(width = 0.5) %>% 
  flextable::border_inner_v(part="all", border = flextable::fp_border_default(color="gray", width = 1) )
```

\newpage

## Historique des types d'écoulement

Les pourcentages de chaque type d'écoulement selon la typologie départementale sont présentés ci-dessous par années, mois et campagnes (usuelles *usue* et complémentaires *comp*).

```{r bilan ecoulement historique, results='asis', echo=FALSE, fig.width=11, fig.height=7, dpi=600}
onde_bilan_ecoulement_historique <-
  params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  calculer_bilan_ecoulement(onde_df = .,
                            mod = lib_ecoul,
                            mod_levels = c("Ecoulement visible acceptable",
                                           "Ecoulement visible faible",
                                           "Ecoulement non visible",
                                           "Assec",
                                           "Observation impossible",
                                           "Donnée manquante"),
                            referentiel_onde = "Typologie départementale",
                            force_complementaire = T) %>% 
  dplyr::mutate(Label_p = gsub(x = Label_p, '%', replacement = ''))

produire_graph_type_ecoulement(data_bilan = onde_bilan_ecoulement_historique,
                               lib_ecoulement = lib_ecoul,
                               historique = T) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, size = 7, hjust = 1))
```

\newpage

## Historique des assecs

L'historique des assecs peut être appréhender avec les 3 graphiques suivants :

- Le graphique **a)** permet de visualiser simultanément la fréquence des assecs sur la période estivale (de mai à septembre inclus) en fonction des années. Le pourcentage de *stations d'observation en assec* est calculé par le rapport entre le nombre de stations ayant la <span custom-style="Assec_style">*modalité assec*</span> et le nombre de stations observées dans le mois.

- Le graphique **b)** permet de visualiser la moyenne annuelle des stations en assecs (c.a.d les variations interannuelles).

- Le graphique **c)** illustre la durée des assecs pour les stations du département sur la période estivale (de mai à septembre inclus). La durée des assecs pour une station est calculée selon le nombre de mois consécutifs où des observations avec la <span custom-style="Assec_style">*modalité assec*</span> est rapportée. La plus grande séquence d'observation en assec est gardée pour le calcul de la durée (rq. *entre observations successives, l'écoulement peut revenir visible*). Ainsi, les durées en assec peuvent aller de 0 mois (c.à.d. des écoulements toujours visibles et consécutivement observés sur la période estivale) à 5 mois (c.à.d.  des assecs toujours observés sur la période estivale). Le pourcentage représenté par chaque classe de durée est calculé pour chaque année d'observation. 

```{r historique, results='asis', echo=FALSE, fig.width=6.5, fig.height=8, dpi=300}

partA <-
## graph a)
params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  calculer_assecs_heatmap(onde_df = .) %>% 
  produire_graph_heatmap_assecs(heatmap_df = ., autoscale = T)

partB <-
## graph b)
params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  calculer_assecs_heatmap(onde_df = .) %>% 
  dplyr::group_by(Annee) %>% 
  dplyr::summarise(pc_assec_usuelles = mean(pourcentage_assecs, na.rm = T)/100) %>% 
  {
    ggplot2::ggplot(data = .,
                    aes(x = Annee, y = pc_assec_usuelles)) +
      ggplot2::geom_line(col = "#c20000") +
      ggplot2::geom_point(fill = "#c20000", pch= 21, size=3) +
      ggplot2::labs(x = "Années",
                    y = "Pourcentage") +
      ggplot2::scale_y_continuous(limits = c(0, max(.$pc_assec_usuelles) + 0.03), 
                                  labels= scales::percent_format(1)) +
      ggplot2::scale_x_continuous(breaks = scales::breaks_width(1)) +
      ggplot2::labs(title = "Proportion moyenne annuelle des stations en assecs") +
      ggplot2::theme_bw() +
      ggplot2::theme(title = ggplot2::element_text(size = 9,face = 'bold'), 
                     axis.text.x = ggplot2::element_text(size=9, angle = 45, hjust = 1),
                     axis.text.y = ggplot2::element_text(size=9))
  }

partC <-
## graph c)
params$onde_df %>%
  dplyr::filter(code_departement == params$code_departement) %>% 
  calculer_recurrence_assecs(onde_df = .) %>% 
  produire_graph_reccurrence_assecs(df_assecs = .)


plot_historique <-
  (partA/partB/partC) + 
  patchwork::plot_layout(heights = c(1.7, 1.1, 2.3)) +
  patchwork::plot_annotation(tag_levels = "a",tag_suffix = ')',
                             #title = "Test",
                             caption = paste("Source: réseau ONDE (OFB)\n ©OFB", 
                                             format(Sys.time(), '%Y'), "- Date d'édition:",format(Sys.time(), '%d/%m/%Y'))) &
  theme(plot.title = element_text(size = 8, face='bold'),
        plot.tag = element_text(face = 'bold'))

plot_historique
```

\newpage

## Historique des observations par stations regroupées par Zones d'alerte Propluvia

Ci-dessous les stations ONDE du département sont réparties selon les **zones d'alerte Propluvia** auxquelles elles appartiennent (noms issus des  [données Propluvia](https://www.data.gouv.fr/fr/datasets/donnee-secheresse-propluvia/)). Pour chaque station, l'historique retrace les observations des campagnes usuelles et complémentaires avec la **typologie départementale** définie précédemment. 

```{r historique stations, results='asis', echo=FALSE, dpi=300, fig.height= 3.3, fig.width= 5.5, message=FALSE}
onde_dpt <- 
  params$onde_df %>% 
  dplyr::filter(code_departement == params$code_departement) %>% 
  dplyr::filter(etat_station == 'Active') %>% 
  dplyr::mutate(
    Annee = as.numeric(Annee),
    Mois = format(as.Date(date_campagne), "%m"), 
    Mois_campagne = lubridate::ym(paste0(Annee,Mois,sep="-"))
  ) %>% 
  dplyr::mutate(
    lib_ecoul_dpt = dplyr::case_when(
      libelle_ecoulement == 'Ecoulement visible' ~ 'Ecoulement visible acceptable',
      TRUE ~ libelle_ecoulement
    )
  )

onde_dpt_propluvia <-
  ajouter_zones_propluvia(onde_df = onde_dpt,
                          propluvia_shape = propluvia_zone)

libelle_propluvia_dpt <- unique(onde_dpt_propluvia$libel)

for (j in 1:length(libelle_propluvia_dpt)){
  # section par zones d'alerte
  cat("### Zones d'alerte: ", libelle_propluvia_dpt[j], "\n")
  
  zones_df <-
  onde_dpt_propluvia %>% 
    dplyr::filter(libel == libelle_propluvia_dpt[j])
  
  graphs_stations <- 
  purrr::map(
    .x = unique(zones_df$code_station), 
    .f = produire_graph_pour_une_station_v2, 
    type_mod = lib_ecoul_dpt,
    onde_df = zones_df,
    mod_levels = c("Assec", 
                   "Ecoulement\nnon visible", 
                   "Ecoulement\nvisible\nfaible", 
                   "Ecoulement\nvisible\nacceptable", 
                   "Observation\nimpossible", 
                   "Donnée\nmanquante"),
    mod_colors = onde_5mod
  ) %>% 
  purrr::set_names(unique(zones_df$code_station))
  
  walk(.x = graphs_stations, ~ print(.x))

  # saut de page
  cat('\n')
  cat('\n')
}

```

\newpage

## Commentaires spécifiques

:::{custom-style="Style1"}

Ajouter les éventuels commentaires ici

:::
